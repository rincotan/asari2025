<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>STEPページ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h4>ここはちきゅう</h4>

    <!-- <div id="pc-warning">※スマホ専用サイトです。スマートフォンでご利用ください。</div> -->
    <div class="page active">
      <h2 id="step-title"></h2>

      <div class="story-box">
        冊子と5枚の謎を組み合わせて
        <div>彼の名前を導こう</div>
      </div>
      <button class="story-btn">ストーリーを振り返る</button>

      <!-- STEP内の小問ボタン -->
      <div id="problem-grid"></div>

      <!-- STEP解答欄 -->
      <div class="input-group">
        <input
          type="text"
          id="step-input"
          placeholder="ひらがなと半角数字のみで入力してね"
        />
        <button id="step-submit">決定</button>
      </div>
      <button id="hint-btns">ヒント</button>
      <!-- ヒントボタンのすぐ下に追加 -->
      <div id="hint-area" style="display: none">
        <!-- STEP1のヒント -->
        <div class="step1-hints" style="display: none">
          <details open>
            <summary>ヒント1</summary>
            今までの答えというのは、このサイトで解いた5問の答えです。
            枠の中の数字がそれぞれの問題番号を指しています。
          </details>
          <details>
            <summary>ヒント2</summary>
            入力した答えそのままではしりとりは成立しません。今までの問題を見返してみましょう。
          </details>
          <details>
            <summary>ヒント3</summary>
            問題3を見てみましょう。
          </details>
          <details>
            <summary>ヒント4</summary>
            二重の四角は英語に変換する印でした。
          </details>
          <details>
            <summary>ヒント5</summary>
            「とけい」は問題3より、watchで考えればいいとわかります。
            英語でしりとりをして、線でつなぎましょう。
          </details>
          <details>
            <summary>解説</summary>
            <img
              src="images/step1-ans.png"
              onerror="this.style.display='none'"
              style="
                width: 90%;
                max-width: 300px;
                margin: 10px auto;
                border: 2px solid #ddd;
                border-radius: 8px;
              "
            />
            <div
              style="
                margin-top: 10px;
                font-size: 0.9em;
                line-height: 1.4;
                text-align: left;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
              "
            >
              問題3から、2重の四角があるので英語で答えを埋めればいいとわかります。問題1～5の答えを英語で埋めて、しりとりとなるように線でつなげると「たいたん」が現れます。
            </div>
          </details>
        </div>

        <!-- STEP2のヒント -->
        <div class="step2-hints" style="display: none">
          <details open>
            <summary>ヒント1</summary>
            まずは答えを書き出してみましょう。
          </details>
          <details>
            <summary>ヒント2</summary>
            「7つの謎」とありますが、7つ目の謎とはなんでしょうか。
          </details>
          <details>
            <summary>ヒント3</summary>
            7つ目の謎とはこのクロスワードのことです。
          </details>
          <details>
            <summary>ヒント4</summary>
            つまり、このクロスワードを完成させることができればこの謎の答えもわかるようです。
          </details>
          <details>
            <summary>ヒント5</summary>
            「この謎の答えは2文字」とあることから、4文字が入るマスが1つ多く、3文字が入るマスと2文字入るマスが1つずつ足りないことがわかります。
          </details>
          <details>
            <summary>ヒント6</summary>
            右側縦4文字のマスの3文字目のマスを、縦3マスの1文字目と右側縦4文字のマスの2文字目の間に移動しましょう。
          </details>
          <details>
            <summary>ヒント7</summary>
            「問題4の答えは縦の鍵」に注意して埋めましょう。問題1～6の答え以外の言葉が、このクロスワードの答えです。
          </details>
          <details>
            <summary>解説</summary>
            <img
              src="images/step2-ans.png"
              onerror="this.style.display='none'"
              style="
                width: 90%;
                max-width: 300px;
                margin: 10px auto;
                border: 2px solid #ddd;
                border-radius: 8px;
              "
            />
            <div
              style="
                margin-top: 10px;
                font-size: 0.9em;
                line-height: 1.4;
                text-align: left;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
              "
            >
              図のようにマスを移動させることで7つ目の謎の答えが現れるので、それがこのクロスワードの答えとなります。
            </div>
          </details>
        </div>

        <!-- STEP3のヒント -->
        <div class="step3-hints" style="display: none">
          <details open>
            <summary>ヒント1</summary>
            まずは最初の指示の通りに並べてみましょう
          </details>
          <details>
            <summary>ヒント2</summary>
            <div
              style="display: flex; flex-direction: column; align-items: center"
            >
              <img
                src="images/ans3_1.png"
                alt="解説画像"
                style="
                  max-width: 90%;
                  max-height: 220px;
                  border: 2px solid #ddd;
                  border-radius: 8px;
                  vertical-align: middle;
                  display: block;
                  margin-bottom: 6px;
                "
              />
              <div style="align-self: flex-start; text-align: left">
                指示通りに図形を置くとこのようになります
              </div>
            </div>
          </details>
          <details>
            <summary>ヒント3</summary>
            矢印の先の文字をつなげて読むと「鏡文字上から」となります
          </details>
          <details>
            <summary>ヒント4</summary>
            鏡文字を上から読むと「まわして灰色線繋ぎ通るもじ」となります
          </details>

          <details>
            <summary>ヒント5</summary>
            ｢まわして灰色線繋ぎ…｣とは、灰色の線が繋がるようにそれぞれの画像を回転させて当てはめる、という意味です。やってみましょう。
          </details>
          <details>
            <summary>ヒント6</summary>
            <div
              style="display: flex; flex-direction: column; align-items: center"
            >
              <img
                src="images/ans3_3.png"
                alt="解説画像"
                style="
                  max-width: 90%;
                  max-height: 220px;
                  border: 2px solid #ddd;
                  border-radius: 8px;
                  vertical-align: middle;
                  display: block;
                  margin-bottom: 6px;
                "
              />
              <div style="align-self: flex-start; text-align: left">
                回したものがこちらです。
              </div>
            </div>
          </details>
          <details>
            <summary>ヒント7</summary>
            灰色の線を繋ぎ、通った文字を読むと「矢印の先下から」となります
          </details>
          <details>
            <summary>ヒント8</summary>
            ｢矢印の先｣は、灰色線を繋げた時の矢印の位置でその先を読みましょう。
          </details>
          <details>
            <summary>ヒント9</summary>
            下という文字が立体的であることに着目しましょう
          </details>
          <details>
            <summary>ヒント10</summary>
            重ねた時に下になっているものから順番に矢印の先にある文字を読んでいきます
          </details>
          <details>
            <summary>解説</summary>
            <div id="ans3-slider" style="text-align: center; margin: 10px 0">
              <div
                style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 10px;
                "
              >
                <button
                  id="ans3-prev"
                  style="
                    background: #000;
                    border: none;
                    color: #fff;
                    font-family: 'しねきゃぷしょん', 'Shin-Caption', sans-serif;
                    opacity: 1;
                    cursor: pointer;
                  "
                >
                  ＜
                </button>
                <img
                  id="ans3-img"
                  src="images/ans3_1.png"
                  alt="解説画像"
                  style="
                    max-width: 90%;
                    max-height: 220px;
                    border: 2px solid #ddd;
                    border-radius: 8px;
                    vertical-align: middle;
                  "
                />
                <button
                  id="ans3-next"
                  style="
                    background: #000;
                    border: none;
                    color: #fff;
                    font-family: 'しねきゃぷしょん', 'Shin-Caption', sans-serif;
                    opacity: 1;
                    cursor: pointer;
                  "
                >
                  ＞
                </button>
              </div>
              <div
                id="ans3-page"
                style="margin-top: 8px; font-size: 0.95em; color: #555"
              ></div>
            </div>
            <script>
              (function () {
                const images = [
                  "images/ans3_1.png",
                  "images/ans3_2.png",
                  "images/ans3_3.png",
                  "images/ans3_4.png",
                ];
                let idx = 0;
                const img = document.getElementById("ans3-img");
                const prev = document.getElementById("ans3-prev");
                const next = document.getElementById("ans3-next");
                const page = document.getElementById("ans3-page");

                function update() {
                  img.src = images[idx];
                  prev.disabled = idx === 0;
                  next.disabled = idx === images.length - 1;

                  // グレーアウトとカーソル制御
                  prev.style.opacity = prev.disabled ? "0.4" : "1";
                  prev.style.cursor = prev.disabled ? "not-allowed" : "pointer";
                  next.style.opacity = next.disabled ? "0.4" : "1";
                  next.style.cursor = next.disabled ? "not-allowed" : "pointer";

                  // ページ数表示
                  page.textContent = idx + 1 + " / " + images.length;
                }

                prev.addEventListener("click", function () {
                  if (idx > 0) {
                    idx--;
                    update();
                  }
                });
                next.addEventListener("click", function () {
                  if (idx < images.length - 1) {
                    idx++;
                    update();
                  }
                });
                update();
              })();
            </script>
            <div
              style="
                margin-top: 10px;
                font-size: 0.9em;
                line-height: 1.4;
                text-align: left;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 4px;
              "
            >
              「うらがえす」というボタンをおして現れる小問の紙の裏側を並べる問題でした。指示通りに紙を並べると、新たな指示がどんどん出てきます。
              指示通りにしていくと最終的に「矢印の先下から」が現れます。ここで、「下」という文字が立体的なことに注目すると、｢下｣というのは紙の重なりを考慮した｢下｣ということが分かります。よって、重ねた時に下になっているものから順に矢印の先にある文字を読むと「こめっと06」となり、これが答えのパスワードです。
            </div>
          </details>
        </div>
      </div>
      <button id="hint-btns" class="revBtn">小問の裏一覧</button>
      <div
        id="subproblem-images"
        style="display: none; margin-top: 10px; text-align: center"
      >
        <div
          style="
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
          "
        >
          <img
            src="images/3-1-2.png"
            alt="3-1-2"
            style="max-width: 45%; flex: 1 1 45%; display: block"
          />
          <img
            src="images/3-2-2.png"
            alt="3-2-2"
            style="max-width: 45%; flex: 1 1 45%; display: block"
          />
          <img
            src="images/3-3-2.png"
            alt="3-3-2"
            style="max-width: 45%; flex: 1 1 45%; display: block"
          />
          <img
            src="images/3-4-2.png"
            alt="3-4-2"
            style="max-width: 45%; flex: 1 1 45%; display: block"
          />
          <img
            src="images/3-5-2.png"
            alt="3-5-2"
            style="max-width: 45%; flex: 1 1 45%; display: block"
          />
          <img
            src="images/3-6-2.png"
            alt="3-6-2"
            style="max-width: 45%; flex: 1 1 45%; display: block"
          />
        </div>
      </div>
    </div>

    <!-- Storyオーバーレイ -->
    <div id="story-overlay" style="display: none">
      <div class="story-bg"></div>
      <div class="story-center">
        <div class="intro-story">
          <h2 class="story-title">～STORY～</h2>
          <section id="story-section-step1" class="step-story-section">
            <div class="story-chat">
              <div class="message user">
                <div class="chat user">記憶喪失じゃん！！！</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  だだだだだ、大丈夫！！<br />はい、これ
                </div>
              </div>

              <div class="message user">
                <div class="chat user">
                  なにこれ…？<br />小さい紙5枚と…文字が散りばめられた紙？
                </div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  これは僕の名刺！宇宙旅行中に出会った生き物に渡してるんだ〜
                </div>
              </div>

              <div class="message user">
                <div class="chat user">へ〜、もしかして謎解き？</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  そう！よくわかったね、謎解きで名前知ってもらったらずっと覚えててくれるかなと思って作ったんだ！
                </div>
              </div>

              <div class="message user">
                <div class="chat user">いいね。私謎解き大得意だよ</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">自信作だけど、君に解けるかな…？</div>
              </div>

              <div class="message user">
                <div class="chat user">
                  ふっふっふ秒速で解いちゃうよ〜……って雑談してる場合じゃないよ！！<br />記憶喪失なんでしょ？そもそも、自信作なのにこれ見て思い出さないの？
                </div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">全然……</div>
              </div>

              <div class="message user">
                <div class="chat user">なんでよ…</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">と、とにかく解いてみてよ</div>
              </div>
            </div>
          </section>

          <section id="story-section-step2" class="step-story-section">
            <div class="story-chat">
              <div class="message user">
                <div class="chat user">あなた、タイタンって言うのね！</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  そう！僕はタイタン！！ありがとう！<br />君って謎解きが本当に得意なんだね！
                </div>
              </div>

              <div class="message user">
                <div class="chat user">えへへ…次もドンと来い！</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  本当に助かるよ、君がいればすぐ帰れちゃいそう！
                </div>
              </div>

              <div class="message user">
                <div class="chat user">それでそれで？次何すればいい？</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  そうだった、とりあえず宇宙船を見てくれないかな
                </div>
              </div>

              <div class="message user">
                <div class="chat user">うん！</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div id="chat-dialog">―宇宙船の目の前―</div>

              <div class="message user">
                <div class="chat user">でっか…</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  中を見せてあげたい所なんだけど、緊急時の入り方を忘れちゃって…
                </div>
              </div>

              <div class="message user">
                <div class="chat user">
                  そんなことある！？あ、記憶喪失か…<br />なんでこうも重要なことばっかり…
                </div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  どうしたら開くんだっけ…<br />う〜ん……………………
                </div>
              </div>

              <div class="message user">
                <div class="chat user">あれ、ロケットになんか書いてあるよ</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div id="chat-dialog">「うちゅうせんのあけかた」</div>

              <div class="message user">
                <div class="chat user">タイタン不用心すぎ！？</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>
            </div>
          </section>

          <section id="story-section-step3" class="step-story-section">
            <div class="story-chat">
              <div class="message user">
                <div class="chat user">
                  かぎ？そんな当たり前な…ねぇタイタン？
                </div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">あっ</div>
              </div>

              <div class="message user">
                <div class="chat user">えっ</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">じゃじゃーん宇宙船のかぎ〜！</div>
              </div>

              <div class="message user">
                <div class="chat user">…</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  ごっごめん！非常用のドアの鍵が別にあるってこと忘れてて…
                </div>
              </div>

              <div class="message user">
                <div class="chat user">
                  タイタンよくこれまで無事に旅してきたね…
                </div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  実は僕これまで通った惑星全部で墜落しちゃってて、この宇宙船もボロボロなんだ…
                </div>
              </div>

              <div class="message user">
                <div class="chat user">無事じゃないじゃん！</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">出発したとたんに墜落したり…</div>
              </div>

              <div class="message user">
                <div class="chat user">おつかれタイタン</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">
                  ありがとう！でももう宇宙船もあいたしまた旅に出れるよ！
                </div>
              </div>

              <div class="message user">
                <div class="chat user">
                  パスワードを入力してって書いてあるよ？
                </div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">あ〜〜…</div>
              </div>

              <div class="message user">
                <div class="chat user">この流れは……</div>
                <img src="images/user_icon.png" alt="user icon" class="icon" />
              </div>

              <div class="message alien">
                <img
                  src="images/alien_icon2.png"
                  alt="alien icon"
                  class="icon"
                />
                <div class="chat alien">忘れちゃった！</div>
              </div>
            </div>
          </section>
          <button id="close-story">✕</button>
        </div>
      </div>
    </div>

    <div class="hamburger" id="hamburger">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="menu" id="menu">
      <a href="#" data-step="0">タイトル</a>
      <a href="#" data-step="1">STEP1</a>
      <a href="#" data-step="2" class="locked">STEP2</a>
      <a href="#" data-step="3" class="locked">STEP3</a>
      <a href="last.html" class="locked">Last</a>
    </div>

    <!-- STEP用モーダル（quizと共通の構造） -->
    <div id="result-modal" style="display: none">
      <div class="modal-bg"></div>
      <div class="modal-center">
        <div id="result-content"></div>
        <button id="modal-close-btn">✕ 閉じる</button>
        <button id="modal-next-btn" style="display: none">次へ→</button>
      </div>
    </div>
    <script src="main.js"></script>
    <script>
      const params2 = new URLSearchParams(window.location.search);
      const step = params2.get("step");

      // stepの値に応じてCSS変数を変更
      if (step === "1") {
        document.documentElement.style.setProperty(
          "--step-submit-hover",
          "#f7bfc7"
        );
      } else if (step === "2") {
        document.documentElement.style.setProperty(
          "--step-submit-hover",
          "#7991ff"
        );
        console.log("出てこい!!!!!!!!!!!!!!");
      } else if (step === "3") {
        document.documentElement.style.setProperty(
          "--step-submit-hover",
          "#ffde59"
        );
      }

      // ヒントボタンの表示切替
      const hintBtn = document.getElementById("hint-btns");
      const hintArea = document.getElementById("hint-area");

      if (hintBtn && hintArea) {
        hintBtn.addEventListener("click", function () {
          // 現在のSTEPに応じてヒントを表示
          const step1Hints = document.querySelector(".step1-hints");
          const step2Hints = document.querySelector(".step2-hints");
          const step3Hints = document.querySelector(".step3-hints");

          // すべてのヒントを非表示
          if (step1Hints) step1Hints.style.display = "none";
          if (step2Hints) step2Hints.style.display = "none";
          if (step3Hints) step3Hints.style.display = "none";

          // 現在のSTEPのヒントを表示
          if (step === "1" && step1Hints) {
            step1Hints.style.display = "block";
          } else if (step === "2" && step2Hints) {
            step2Hints.style.display = "block";
          } else if (step === "3" && step3Hints) {
            step3Hints.style.display = "block";
          }
          if (
            hintArea.style.display === "none" ||
            hintArea.style.display === ""
          ) {
            hintArea.style.display = "block";
          } else {
            hintArea.style.display = "none";
          }
        });
      }

      // 小問の裏一覧ボタンの表示制御
      const subImgBtn = document.querySelector(".revBtn");
      const subImgArea = document.getElementById("subproblem-images");

      if (subImgBtn && subImgArea) {
        // Step3の小問1〜6を全て正解した時だけボタンを表示
        if (step === "3") {
          const solved = JSON.parse(localStorage.getItem("solvedQuiz") || "{}");
          const allStep3Solved =
            solved["s3q1"] === true &&
            solved["s3q2"] === true &&
            solved["s3q3"] === true &&
            solved["s3q4"] === true &&
            solved["s3q5"] === true &&
            solved["s3q6"] === true;

          if (allStep3Solved) {
            subImgBtn.style.display = "block";
          } else {
            subImgBtn.style.display = "none";
          }
        } else {
          subImgBtn.style.display = "none";
        }

        subImgBtn.addEventListener("click", function (e) {
          // 「小問の裏一覧」ボタンのときだけ画像をトグル
          if (subImgBtn.textContent === "小問の裏一覧") {
            e.stopPropagation();
            subImgArea.style.display =
              subImgArea.style.display === "none" ||
              subImgArea.style.display === ""
                ? "block"
                : "none";
          }
        });
      }
    </script>
  </body>
</html>
