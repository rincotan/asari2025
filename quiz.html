<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>小問題ページ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h4>ここはちきゅう</h4>

    <!-- <div id="pc-warning">※スマホ専用サイトです。スマートフォンでご利用ください。</div> -->

    <div class="page active" style="text-align: center">
      <h2 id="quiz-title"></h2>
      <img id="quiz-img" src="" alt="" style="max-width: 80%; margin: 20px 0" />
      <div class="input-group">
        <input type="text" id="quiz-answer" placeholder="答えをひらがなで入力してください" />
        <button id="submit-btn">決定</button>
      </div>
      <p id="quiz-answer-result"></p>
      <div class="bottom-buttons">
        <button id="close-btn" onclick="goToStep(stepNum, true)">閉じる</button>
        <button id="hint-btn">ヒント</button>
        <button id="rev-btn" style="display: none;white-space: nowrap;">うらがえす</button>
      </div>
      <button id="help-btn" style="display: none;">問題文が読めなかった人へ</button>
      <a id="help-btn2" href="https://www.toinfes.com/" target="_blank" style="display: none;">
        桐陰祭ホームページはこちら
      </a>
      
      <!-- Help section for Step2 Problem 3 -->
      <div id="help-section" style="display: none; margin-top: 20px;">
        <p style="font-size: 18px; margin-bottom: 10px;">どこを見たいですか？</p>
        <div class="input-group">
          <input type="text" id="help-input" placeholder="入力してください" />
          <button id="help-submit-btn">確認</button>
        </div>
        <div id="help-result" style="margin-top: 15px; font-size: 16px;"></div>
      </div>
      
      <div id="hint-area" style="display:none;"></div>        
      </div>
    </div>

    <div class="hamburger" id="hamburger">
      <div></div>
      <div></div>
      <div></div>
    </div>
    <div class="menu" id="menu">
      <a href="#" data-step="0">タイトル</a>
      <a href="#" data-step="1">STEP1</a>
      <a href="#" data-step="2" class="locked">STEP2</a>
      <a href="#" data-step="3" class="locked">STEP3</a>
      <a href="last.html" class="locked">Last</a>
    </div>

    <!-- 正解・不正解モーダル -->
    <div id="result-modal" style="display:none;">
      <div class="modal-bg"></div>
      <div class="modal-center">
        <div id="result-content"></div>
        <button id="modal-close-btn">✕ 閉じる</button>
        <button id="modal-next-btn" style="display:none;">次の問題へ→</button>
      </div>
    </div>

    <script src="main.js"></script>

    <script>
      //const params = new URLSearchParams(window.location.search);
      //const stepNum = parseInt(params.get("step")) || 1;
      const quizNum = parseInt(params.get("quiz")) || 1;
      if (stepNum === 2 && quizNum === 3 && !params.get("title")) {
        params.set("title", "たむかむごごたて");
        window.location.search = params.toString();
      }
      console.log(stepNum, quizNum);
      

      const quizData = {
        1: {
          1: {
            img: "images/q11.png",
            ans: "とけい",
            hints:[
              "ひらがなを漢字に直してみましょう",
              "漢字をいくつかのパーツに分割してみましょう",
              "矢印の先にあるパーツを取り出してみましょう"
            ],
            explanation:[
              "ひらがなを漢字に直す",
              "漢字を複数のパーツに分ける",
              "矢印の先にあるパーツを取り出してカタカナとして読む",
              "よって答えは「とけい」"
            ],
            explanation_img: "images/q11-ans.png"
          },
          2: {
            img: "images/q12.png",
            ans: "ぞう",
            hints:["矢印がどのような変換を表しているのか考えましょう"],
            explanation: [
              "↔︎は対義語を表す矢印です",
              "⇄は反対から読むことを表す矢印です",
              "→は濁点を付けることを表す矢印です",
              "よって答えは「ぞう」です"
            ],
            explanation_img: "images/q12-ans.png"
          },
          3: {
            img: "images/q13.png",
            ans: "いえ",
            hints:[
              "枠線はある変換を表しています",
              "四角の中の単語をイラストを英語に直してみましょう",
		          "魔女はwitch,時計はwatch,ネズミはmouse,馬はhorseです",
              "矢印の上の数字の意味を考えましょう"
            ],
            explanation: [
              "二重の四角の中のイラストを英語に直す",
              "矢印の上の数字は置き換える文字の位置を表している",
              "よって答えは'house'つまり「いえ」"
            ],
            explanation_img: "images/q13-ans.png"
          },
          4: {
            img: "images/q14.png",
            ans: "にじ",
            hints:[
              "左側には同じ言葉が入ります",
              "黒丸に入る文字をうまく並べると右の言葉になります",
              "左に入る言葉は日照時間です"
            ],
            explanation: [
              "黒く塗りつぶされた部分に入る文字を抜き出して入れ替えたりすると右の言葉になる",
              "左側にはにっしょうじかんが入る",
              "1文字目は「に」",
              "6文字目は「じ」",
              "よって答えは「にじ」"
            ],
            explanation_img: "images/q14-ans.png"
          },
          5: {
            img: "images/q15.png",
            ans: "とら",
            hints:[
              "数字に入る文字を考えて順番に並べてみましょう",
              "■やかけている部分の意味を考えましょう",
              "①から⑦にはドレミファソラシが入ります"
            ],
            explanation: [
              "数字は音階を示している",
              "■は濁点を表している",
              "①のかけている部分は濁点が取り除かれていることを表している",
              "よって答えは「とら」"
            ],
            explanation_img: "images/q15-ans.png"
          },
        },
        2: {
          1: {
            img: "images/q21.png",
            ans: "かみなり",
            hints:[
              "熟語を作るパズルではありません",
              "漢字を４つ作ってください",
              "答えはできた漢字の一つです"
            ],
            explanation: [
              "熟語ではなく漢字を4つ作るパズルになっていた",
              "中央に「田」を入れるとすべて成立する",
              "できた漢字の中で「か」から始まる四文字の読み方を持つのは「雷」のみ",
              "よって答えは「かみなり」",
            ],
            explanation_img: "images/q21-ans.png"
          },
          2: {
            img: "images/q22.png",
            ans: "さなぎ",
            hints:[
              "イラストが何を表しているのか考えましょう",
              "桐陰祭のパンフレットや公式Webサイトをご覧ください",
              "イラストはクラスを表しています",
              "五十音表を下にイラスト→数字(クラス)→ひらがなのように変換してみてください"
            ],
            explanation:[
              "イラストは全てクラスを表している",
              "〇年✕組を〇-✕という形に直す",
              "イラストの左右が逆になっているクラスは-の前後を入れ替える",
              "〇-✕の◯を五十音表の行(列)に✕を段に対応させる",
              "よって答えはさなぎ"
            ],
            explanation_img: "images/q22-ans.png"
          },
          3: {
            img: "images/q23.png",
            ans: "かみ",
            hints:[
              "URLをご覧ください",
              "イラストは文字の変換を表しています",
              "イラストはたぬき、消しゴム、手紙です"
            ],
            explanation: [
              "URLの末尾の「たむかむごごたて」という部分に注目する",
              "イラストが示す変換を行う",
              "よって答えは「かみ」"
            ],
            explanation_img: "images/q23-ans.png"
          },
          4: {
            img: "images/q24.png",
            ans: "さんま",
            hints:[
              "方角は東ではありません",
              "一つの◯に一つの文字が入るわけではありません",
              "◯の個数に注目してください",
              "地名は愛知、方角は西です"
            ],
            explanation: [
              "ひらがな部分に〇の個数を表す数字をくっつけて読む",
              "〇〇〇まの〇の個数は3個",
              "よって答えは「さんま」"
            ],
            explanation_img: "images/q24-ans.png"
          },
          5: {
            img: "images/q25.png",
            ans: "かまきり",
            hints:[
              "イラストはやかん、トマト、スキー、まりもです",
              "真ん中の文字をつなげてみてください"
            ],
            explanation: [
              "イラストがあらわしているのはすべて三文字の言葉",
              "矢印は真ん中の文字を読めという指示を表している",
              "よって答えは「かまきり」"
            ],
            explanation_img: "images/q25-ans.png"
          },
          6: {
            img: "images/q26.png",
            ans: "かたな",
            hints:["表は五十音表を表しています"],
            explanation: [
              "五十音表の一部が描かれている",
              "数字が書かれているマスに入る文字を読む",
              "よって答えは「かたな」"
            ],
            explanation_img: "images/q26-ans.png"
          },
        },


        3: {
          1: {
            img: "images/q31.png",
            ans: "くに",
            hints:[
              "７つあるものと言えばなんでしょう",
              "赤と青色に注目しましょう"
            ],
            explanation:[
              "それぞれのマスには曜日の名前が入ります",
              "よって答えは「くに」"
            ],
            explanation_img: "images/q31-ans.png"
          },
          2: {
            img: "images/q32.png",
            ans: "さい",
            hints:[
              "イラストの周辺にある＿や｜は文字の変換を表しています",
              "絵はそれぞれあめ、いも、くず、きじ、たきです",
              "五十音表を思い浮かべてみてください"
            ],
            explanation: [
              "イラストで示された言葉を線がある方向に一文字ずらす",
              "イラストがあらわしているのは「たき」",
              "よって答えは「さい」"
            ],
            explanation_img: "images/q32-ans.png"
          },
          3: {
            img: "images/q33.png",
            ans: "はんげつ",
            hints:["矢印の形にも注目してイラストが指しているものを２通り考えてみてください"],
            explanation: [
              "イラストが指しているものを２通り考える",
              "丸みを帯びた矢印の方はイラストの線を丸くする",
              "よって答えは「はんげつ」"
            ],
            explanation_img: "images/q33-ans.png"
          },
          4: {
            img: "images/q34.png",
            ans: "じんせい",
            hints:[
              "左上の2022は2022年を指しています",
              "右上のイラストはクレジットカードです",
              "下のイラストは成人式です",
              "連想できる言葉を真ん中に入れて、数字通りの順番で読んでみましょう"
            ],
            explanation:[
              "③④①②＝せいじん",
              "よって答えはじんせい",
            ],
            explanation_img: "images/q34-ans.png"
          },
          5: {
            img: "images/q35.png",
            ans: "ちょき",
            hints:[
              "「パー」「グー」「チョキ」ではありません\n「かみ」「いし」「はさみ」でもありません",
              "①＝ま、②＝ち、を埋めてみましょう",
              "手の向きに着目してみましょう",
              "｢画面外｣を聞かれているということは…？",
              
              "対戦結果が入ります"
            ],
            explanation:[
              "矢印の先は画面外の手との対戦結果を表している",
              "パーで負け、グーで勝ち、チョキであいこなので画面外はチョキ",
              "よって答えは「ちょき」"
            ],
            explanation_img: "images/q35-ans.png"
          },
          6: {
            img: "images/q361.png",
            ans: ["star","すたー","ほし","Star"],
            hints:[
               "イラストをよく見てみましょう",
               "入れ子構造になっている事がわかります。拡大する方法はなんでしょうか",
               "イラストをクリックしてみてください",
               "イラストを英語に直してみましょう"
            ],
            explanation:[
              "宇宙＝universe",
              "銀河＝galaxy",
              "地球＝earth",
              "よって答えはstar"
            ],
            explanation_img: "images/q36-ans.png"
          },
        },
      };













      const solvedQuizanswer = localStorage.getItem(`s${stepNum}q${quizNum}`) || "";
      const inputElem = document.getElementById("quiz-answer");
      if (solvedQuizanswer) {
        inputElem.value = solvedQuizanswer;
      }








      document.getElementById(
        "quiz-title"
      ).innerText = `Step${stepNum} 問題${quizNum}`;
      document.getElementById("quiz-img").src = quizData[stepNum][quizNum].img;
      document
        .getElementsByClassName("page")[0]
        .classList.add(`quiz${stepNum}`);

      document.getElementById("submit-btn").onclick = () => {
        const answer = inputElem.value.trim();
        localStorage.setItem(`s${stepNum}q${quizNum}`, answer);
        checkQuizAnswer("quiz-answer", quizData[stepNum][quizNum].ans);
      };
      console.log(document.getElementById("submit-btn").onclick);

      // ステップ3小問6だけズーム画像切り替え
      if (stepNum === 3 && quizNum === 6) {
        const zoomImages = [
          "images/q361.png", // 通常
          "images/q362.png", // ズーム1
          "images/q363.png"  // ズーム2
        ];
        let zoomLevel = 0;
        const quizImg = document.getElementById("quiz-img");
        quizImg.src = zoomImages[zoomLevel];
        quizImg.style.cursor = "zoom-in";
        quizImg.onclick = function () {
          if (zoomLevel < zoomImages.length - 1) {
            zoomLevel++;
            quizImg.src = zoomImages[zoomLevel];
            quizImg.style.cursor = zoomLevel === zoomImages.length - 1 ? "zoom-out" : "zoom-in";
          } else {
            // ズームアウト
            zoomLevel = 0;
            quizImg.src = zoomImages[zoomLevel];
            quizImg.style.cursor = "zoom-in";
          }
        };
      }
      let now_omote_ura = 0;
      document.getElementById("rev-btn").onclick = function() {
        // 最新のsolvedQuizの状態を取得
        const currentSolvedQuiz = JSON.parse(localStorage.getItem("solvedQuiz") || "{}");
        
        if(!currentSolvedQuiz[`s${stepNum}q${quizNum}`]){
          const modal = document.getElementById("result-modal");
          const content = document.getElementById("result-content");
          const closeBtn = document.getElementById("modal-close-btn");
          const nextBtn = document.getElementById("modal-next-btn");

            // 不正解時
          content.innerHTML = `
            <div style="color:#7991ff;font-size:2em;font-weight:bold;">未開放</div>
            <div style="font-size:5em;color:#7991ff;">&#10006;</div>
            <div style="margin-top:10px;font-weight:bold;">この操作はまだ解放されていません</div>
          `;
            nextBtn.style.display = "none";
          

          modal.style.display = "flex";
          closeBtn.onclick = function () {
            modal.style.display = "none";
          };
          return;
        }
        
        // 正解済みの場合は画像切り替え処理を実行
        console.log("うらがえす - 正解済み");
        if (now_omote_ura===1) {
          document.getElementById("quiz-img").src = quizData[stepNum][quizNum].img;
        }
        else{
          document.getElementById("quiz-img").src = `images/3-${quizNum}-2.png`;
        }
        now_omote_ura ^=1;
      };
      if(stepNum===3){
        document.getElementById("rev-btn").style.display = "block";
        
        // 既に正解済みの問題の場合は「うらがえす」ボタンを有効化
        const currentSolvedQuiz = JSON.parse(localStorage.getItem("solvedQuiz") || "{}");
        if(currentSolvedQuiz[`s${stepNum}q${quizNum}`]) {
          const revBtn = document.getElementById("rev-btn");
          if (revBtn) {
            revBtn.style.opacity = "1";
            revBtn.style.cursor = "pointer";
            revBtn.disabled = false;
          }
        }
      }

      document.getElementById("hint-btn").onclick = function() {
        const area = document.getElementById("hint-area");
        // ヒント内容を生成
        const hints = quizData[stepNum][quizNum].hints;
        let html = "";
        hints.forEach((hint, i) => {
          html += `<details${i === 0 ? " open" : ""}>
            <summary>ヒント${i + 1}</summary>
            ${hint}
          </details>`;
        });
        html += `<details>
          <summary>解説を見る</summary>
          ${quizData[stepNum][quizNum].explanation.map(step => `<p>・${step}</p>`).join("")}
          <img src="${quizData[stepNum][quizNum].explanation_img}" alt="解説画像" style="max-width: 100%; margin-top: 10px;" />
        </details>`;
        area.innerHTML = html;
        area.style.display = (area.style.display === "none" || area.style.display === "") ? "block" : "none";
      };

      // Show help button only for Step2 Problem 3
      if (stepNum === 2 && quizNum === 3) {
        document.getElementById("help-btn").style.display = "block";
      }
      if(stepNum === 2 && quizNum === 2){
        document.getElementById("help-btn2").style.display = "block";
      }

      // Help button functionality
      document.getElementById("help-btn").onclick = function() {
        const helpSection = document.getElementById("help-section");
        helpSection.style.display = helpSection.style.display === "none" ? "block" : "none";
      };

      // Help input functionality
      document.getElementById("help-submit-btn").onclick = function() {
        const input = document.getElementById("help-input").value.toLowerCase().trim();
        const result = document.getElementById("help-result");
        
        if (input === "url" || input === "ユーアールエル" || input === "ゆーあーるえる") {
          result.innerHTML = '<a >変換の都合で問題文が読めなくなっちゃいました。かかれている問題文は｢たむかむごこだて｣です</a>';
          // result.style.color = "#2277ee";
        } else {
          result.innerHTML = "正しい入力ではありません。";
          result.style.color = "#ff4444";
        }
      };

      // Allow Enter key to submit help input
      document.getElementById("help-input").addEventListener("keypress", function(e) {
        if (e.key === "Enter") {
          document.getElementById("help-submit-btn").click();
        }
      });
    </script>

  </body>
</html>